# Portal subdomain configuration for portal.abgumich.org
# Only the root path (/) is rewritten to /portal
# All other paths pass through normally to the main site
#
# To deploy:
#   1. Copy this to /etc/nginx/conf.d/portal.conf
#   2. sudo nginx -t && sudo systemctl reload nginx
#   3. If SSL not set up: sudo certbot --nginx -d portal.abgumich.org

server {
    server_name portal.abgumich.org;
    
    # Increase body size for file uploads
    client_max_body_size 100M;

    # Root path only - rewrite to /portal
    # portal.abgumich.org/ -> serves /portal content
    location = / {
        proxy_pass http://localhost:3000/portal;
        proxy_http_version 1.1;
        proxy_set_header Host abgumich.org;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_cache_bypass $http_upgrade;
        
        add_header X-Frame-Options SAMEORIGIN;
        add_header X-XSS-Protection "1; mode=block";
        add_header X-Content-Type-Options nosniff;
    }

    # All other paths - pass through directly to Next.js (no rewriting)
    # This means /projects, /events, /portal, /api, etc. all work normally
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Host abgumich.org;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_cache_bypass $http_upgrade;
        
        # Extended timeouts for API requests
        proxy_read_timeout 120;
        proxy_connect_timeout 120;
        proxy_send_timeout 120;
        
        add_header X-Frame-Options SAMEORIGIN;
        add_header X-XSS-Protection "1; mode=block";
        add_header X-Content-Type-Options nosniff;
    }

    # SSL configuration
    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/portal.abgumich.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/portal.abgumich.org/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# HTTP to HTTPS redirect
server {
    if ($host = portal.abgumich.org) {
        return 301 https://$host$request_uri;
    }
    server_name portal.abgumich.org;
    listen 80;
    return 404;
}
